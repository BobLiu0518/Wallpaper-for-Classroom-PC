<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å®¤å£çº¸ - GUIé…ç½®ç”Ÿæˆå™¨ (By é£æœˆåŒå¤©)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #2c3e50; }
        h1 { display: flex; justify-content: space-between; align-items: center; }
        h2 { border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 40px; }
        fieldset { border: 1px solid #ccc; border-radius: 5px; padding: 15px; margin-bottom: 20px; }
        legend { font-weight: bold; color: #3498db; padding: 0 10px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input[type="text"], input[type="number"], input[type="date"], select, textarea { width: 100%; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; margin-bottom: 10px; }
        input[type="checkbox"] { margin-right: 10px; }
        .checkbox-label { display: flex; align-items: center; margin-bottom: 10px; }
        .action-button { background: #3498db; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; }
        .action-button:hover { background: #2980b9; }
        .countdown-item { display: flex; gap: 10px; align-items: center; padding: 10px; border: 1px dashed #ccc; margin-bottom: 10px; border-radius: 4px; }
        .remove-btn { background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .generate-button { background: #2ecc71; color: white; font-size: 1.2em; border: none; padding: 15px 30px; cursor: pointer; border-radius: 5px; width: 100%; margin-top: 20px; }
        .generate-button:hover { background: #27ae60; }
        #output-container { margin-top: 30px; }
        #output-code { width: 100%; height: 400px; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; background: #2d2d2d; color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; }
        .copy-button { display: block; width: 100%; padding: 10px; margin-top: 10px; background: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .copy-button:hover { background: #e67e22; }
        .help-text { font-size: 0.9em; color: #777; margin-bottom: 10px; padding: 10px; background-color: #ecf0f1; border-left: 4px solid #3498db; border-radius: 4px;}
        .grid-2, .grid-3 { display: grid; gap: 20px; align-items: end; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        .grid-3 { grid-template-columns: 1fr 1fr auto; gap: 20px; }
        .hidden { display: none; }
        .schedule-table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        .schedule-table th, .schedule-table td { border: 1px solid #ccc; padding: 5px; text-align: center; vertical-align: top; }
        .schedule-table th { background-color: #f2f2f2; }
        .schedule-table input, .schedule-table select { margin-bottom: 0; width: 100%; border: none; background-color: transparent; padding: 8px 4px; }
        .schedule-table input:focus, .schedule-table select:focus { outline: 1px solid #3498db; background-color: #fff; }
        .subject-cell > div { display: flex; flex-direction: column; gap: 4px; }
        .time-header { width: 110px; }
        .time-header .help-text { font-size: 0.8em; padding: 5px; margin-top: 5px; text-align: left;}
        .break-row td { background-color: #e0e0e0; font-weight: bold; }
        .reset-button { background-color: #e74c3c; color: white; border: none; padding: 10px 20px; font-size: 0.9em; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h1>
        <span>æ•™å®¤å£çº¸ - GUIé…ç½®ç”Ÿæˆå™¨ï¼ˆBy é£æœˆåŒå¤©ï¼‰</span>
        <button class="reset-button" onclick="resetSettings()">æ¢å¤é»˜è®¤è®¾ç½®</button>
    </h1>
    <p class="help-text" style="text-align:center;">æ‚¨çš„æ‰€æœ‰ç¼–è¾‘å†å²å°†è‡ªåŠ¨ä¿å­˜åœ¨æœ¬æµè§ˆå™¨ä¸­ã€‚ä¸‹æ¬¡æ‰“å¼€æ­¤é¡µé¢å¯ç»§ç»­ç¼–è¾‘ã€‚</p>
    
    <fieldset>
        <legend>é€šç”¨è®¾ç½®</legend>
        <div class="grid-2">
            <div>
                <label class="checkbox-label"><input type="checkbox" id="revWeek">åè½¬å•åŒå‘¨é€»è¾‘</label>
            </div>
            <div>
                <label for="temporaryDayOfWeek">ä¸´æ—¶è°ƒè¯¾</label>
                <select id="temporaryDayOfWeek">
                    <option value="null">é»˜è®¤ (ä¸è°ƒæ•´)</option><option value="0">æ˜ŸæœŸæ—¥</option><option value="1">æ˜ŸæœŸä¸€</option><option value="2">æ˜ŸæœŸäºŒ</option><option value="3">æ˜ŸæœŸä¸‰</option><option value="4">æ˜ŸæœŸå››</option><option value="5">æ˜ŸæœŸäº”</option><option value="6">æ˜ŸæœŸå…­</option>
                </select>
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>è¯¾ç¨‹è¡¨ (ä¸‹æ‹‰é€‰æ‹©æ¨¡å¼)</legend>
        <p class="help-text">è¯·å…ˆè®¾ç½®å¥½æ¯å¤©çš„è¯¾ç¨‹èŠ‚æ•°ï¼Œç„¶åç‚¹å‡»â€œç”Ÿæˆ/æ›´æ–°è¯¾è¡¨æ¨¡æ¿â€æ¥åˆ›å»ºå¯ç¼–è¾‘çš„è¡¨æ ¼ã€‚</p>
        <div class="grid-3">
            <div><label for="morning-periods">ä¸ŠåˆèŠ‚æ•°:</label><input type="number" id="morning-periods" value="5"></div>
            <div><label for="afternoon-periods">ä¸‹åˆèŠ‚æ•°:</label><input type="number" id="afternoon-periods" value="3"></div>
            <button type="button" class="action-button" onclick="generateScheduleTables()">ç”Ÿæˆ/æ›´æ–°æ¨¡æ¿</button>
        </div>
        <hr style="margin: 20px 0;">
        <label class="checkbox-label">
            <input type="checkbox" id="enable-double-week" onchange="handleDoubleWeekToggle()"><small style="margin-right:10px;">å¯ç”¨å•/åŒå‘¨ä¸åŒè¯¾è¡¨</small>
            <small style="color: #e74c3c;">(æç¤º: è¯·å¡«å†™å®Œé»˜è®¤æ¨¡æ¿ï¼Œå†å‹¾é€‰æ­¤é¡¹)</small>
        </label>
        <div id="single-week-schedule-container">
            <h3>å•å‘¨è¯¾è¡¨</h3>
            <div id="single-week-table-wrapper" style="overflow-x: auto;"></div>
        </div>
        <div id="double-week-schedule-container" class="hidden">
            <h3>åŒå‘¨è¯¾è¡¨</h3>
            <div id="double-week-table-wrapper" style="overflow-x: auto;"></div>
        </div>
    </fieldset>
    
    <fieldset>
        <legend>ä¿¡æ¯ä¸æ˜¾ç¤º</legend>
        <div class="grid-2">
            <div>
                <label for="announcementList">æ»šåŠ¨å…¬å‘Š (ä¸€è¡Œä¸€ä¸ª):</label><textarea id="announcementList" rows="4"></textarea>
                <label class="checkbox-label"><input type="checkbox" id="announcementRandomOrder">éšæœºæ’åºå…¬å‘Š</label>
            </div>
            <div>
                <label class="checkbox-label"><input type="checkbox" id="dutyListConsistent" onchange="document.getElementById('duty-double-week-panel').style.display = this.checked ? 'none' : 'block';">å•åŒå‘¨å€¼æ—¥ç”Ÿè¡¨ä¸€è‡´</label>
                <div id="duty-single-week">
                    <label>å•å‘¨å€¼æ—¥ (å‘¨ä¸€è‡³äº”ï¼Œå‘¨å…­æ—¥)</label>
                    <input type="text" id="dutySingleMon" placeholder="å‘¨ä¸€"><input type="text" id="dutySingleTue" placeholder="å‘¨äºŒ">
                    <input type="text" id="dutySingleWed" placeholder="å‘¨ä¸‰"><input type="text" id="dutySingleThu" placeholder="å‘¨å››">
                    <input type="text" id="dutySingleFri" placeholder="å‘¨äº”"><input type="text" id="dutySingleSatSun" placeholder="å‘¨å…­/æ—¥">
                </div>
                 <div id="duty-double-week-panel" class="hidden" style="margin-top: 20px;">
                    <label>åŒå‘¨å€¼æ—¥ (å‘¨ä¸€è‡³äº”ï¼Œå‘¨å…­æ—¥)</label>
                    <input type="text" id="dutyDoubleMon" placeholder="å‘¨ä¸€"><input type="text" id="dutyDoubleTue" placeholder="å‘¨äºŒ">
                    <input type="text" id="dutyDoubleWed" placeholder="å‘¨ä¸‰"><input type="text" id="dutyDoubleThu" placeholder="å‘¨å››">
                    <input type="text" id="dutyDoubleFri" placeholder="å‘¨äº”"><input type="text" id="dutyDoubleSatSun" placeholder="å‘¨å…­/æ—¥">
                </div>
            </div>
        </div>
    </fieldset>
    
    <fieldset>
        <legend>é«˜çº§è®¾å®š</legend>
        <div class="grid-2">
             <div>
                <label>å€’è®¡æ—¶äº‹ä»¶</label>
                <div id="countdown-container" style="margin-bottom: 10px;"></div>
                <button type="button" class="action-button" onclick="addCountdownItem()">+ æ·»åŠ äº‹ä»¶</button>
            </div>
            <div>
                <label class="checkbox-label"><input type="checkbox" id="countdownShowPastDate">æ˜¾ç¤ºå·²è¿‡æœŸçš„äº‹ä»¶</label>
                <label class="checkbox-label"><input type="checkbox" id="countdownAnimation">å¯ç”¨å€’è®¡æ—¶åŠ¨ç”»</label>
                <label class="checkbox-label"><input type="checkbox" id="showTimeSeconds">æ—¶é’Ÿæ˜¾ç¤ºç§’æ•°</label>
                <label class="checkbox-label"><input type="checkbox" id="emojiEnabled">åœ¨è¯¾è¡¨ä¸­å¯ç”¨ Emoji</label>
            </div>
        </div>
    </fieldset>

    <button type="button" class="generate-button" onclick="generateAndSaveConfig()">ğŸš€ ç”Ÿæˆå¹¶ä¿å­˜é…ç½®</button>

    <div id="output-container" class="hidden">
        <h2>ç”Ÿæˆç»“æœ</h2>
        <p class="help-text">è¯·å¤åˆ¶ä»¥ä¸‹æ‰€æœ‰ä»£ç ï¼Œå¹¶è¦†ç›–åˆ°ä½ çš„ `config.js` æ–‡ä»¶ä¸­ã€‚</p>
        <textarea id="output-code" readonly></textarea>
        <button type="button" class="copy-button" onclick="copyToClipboard()">ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
    </div>
</div>

<script>
    const CONFIG_STORAGE_KEY = 'classroomWallpaperConfig_v2'; // ä½¿ç”¨æ–°keyé¿å…ä¸æ—§ç‰ˆå†²çª
    const SUBJECTS = ["è¯­æ–‡", "æ•°å­¦", "å¤–è¯­", "ç‰©ç†", "åŒ–å­¦", "ç”Ÿç‰©", "æ”¿æ²»", "å†å²", "åœ°ç†", "ä½“è‚²", "éŸ³ä¹", "ç¾æœ¯", "ä¿¡æ¯æŠ€æœ¯", "ç­ä¼š", "è‡ªä¹ ", "é›†ä½“å¤‡è¯¾", "é˜…è¯»", "å†™å­—", "åŠ³åŠ¨", { value: "---", text: "---", disabled: true }, { value: "_CUSTOM_", text: "è‡ªå®šä¹‰..." }];
    const defaultSchedule = { "0-0": "å¤–è¯­", "0-1": "åŒ–å­¦", "0-2": "è¯­æ–‡", "0-3": "æ•°å­¦", "0-4": "ç‰©ç†", "0-5": "ç­ä¼š", "0-6": "åœ°ç†", "0-7": "é›†ä½“å¤‡è¯¾", "1-0": "å¤–è¯­", "1-1": "å¤–è¯­", "1-2": "åœ°ç†", "1-3": "æ•°å­¦", "1-4": "ä½“è‚²", "1-5": "è¯­æ–‡", "1-6": "åŒ–å­¦", "1-7": "ç‰©ç†", "2-0": "è¯­æ–‡", "2-1": "è¯­æ–‡", "2-2": "å¤–è¯­", "2-3": "å¤–è¯­", "2-4": "åŒ–å­¦", "2-5": "æ•°å­¦", "2-6": "åœ°ç†", "2-7": "ç‰©ç†", "3-0": "æ•°å­¦", "3-1": "ä½“è‚²", "3-2": "è¯­æ–‡", "3-3": "å¤–è¯­", "3-4": "å¤–è¯­", "3-5": "ç‰©ç†", "3-6": "åœ°ç†", "3-7": "åŒ–å­¦", "4-0": "è¯­æ–‡", "4-1": "åœ°ç†", "4-2": "åŒ–å­¦", "4-3": "æ•°å­¦", "4-4": "æ•°å­¦", "4-5": "ç‰©ç†", "4-6": "ç‰©ç†", "4-7": "å¤–è¯­" };
    
    // --- æœ¬åœ°å­˜å‚¨æ ¸å¿ƒé€»è¾‘ ---
    function saveSettings() {
        const settings = {};
        document.querySelectorAll('input, select, textarea').forEach(el => {
            if (!el.id) return;
            if (el.type === 'checkbox' || el.type === 'radio') {
                settings[el.id] = el.checked;
            } else {
                settings[el.id] = el.value;
            }
        });
        settings.countdownList = [];
        document.querySelectorAll('.countdown-item').forEach(item => {
            settings.countdownList.push({ name: item.querySelector('.countdown-name').value, date: item.querySelector('.countdown-date').value });
        });
        function getScheduleData(weekType) {
            const data = []; const wrapper = document.getElementById(`${weekType}-week-table-wrapper`); if (!wrapper) return data;
            wrapper.querySelectorAll('tbody tr').forEach(row => {
                if (row.classList.contains('break-row')) { data.push({ type: 'break' }); } else {
                    const subjects = Array.from(row.querySelectorAll('.subject-cell')).map(cell => {
                        const select = cell.querySelector('.subject-select');
                        return select.value === '_CUSTOM_' ? cell.querySelector('.custom-subject-input').value : select.value;
                    });
                    data.push({ type: 'class', time: row.querySelector('.time-input').value, subjects: subjects });
                }
            }); return data;
        }
        settings.scheduleData = { single: getScheduleData('single'), double: getScheduleData('double') };
        try {
            localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(settings));
            console.log('Settings saved to Local Storage.');
        } catch (e) { console.error("Failed to save settings:", e); }
    }

    function loadSettings() {
        const savedSettingsJSON = localStorage.getItem(CONFIG_STORAGE_KEY);
        if (!savedSettingsJSON) { initDefaults(); return; }
        try {
            const settings = JSON.parse(savedSettingsJSON);
            console.log('Loading settings from Local Storage.');
            for (const id in settings) {
                const el = document.getElementById(id);
                if (el) {
                    if (el.type === 'checkbox' || el.type === 'radio') { el.checked = settings[id]; } else { el.value = settings[id]; }
                }
            }
            const countdownContainer = document.getElementById('countdown-container'); countdownContainer.innerHTML = '';
            if (settings.countdownList) { settings.countdownList.forEach(item => addCountdownItem(item.name, item.date)); }
            generateScheduleTables();
            function applyScheduleData(weekType, data) {
                const wrapper = document.getElementById(`${weekType}-week-table-wrapper`); if (!data || !wrapper) return;
                const rows = wrapper.querySelectorAll('tbody tr:not(.break-row)'); let classRowIndex = 0;
                data.forEach(rowData => {
                    if (rowData.type === 'class' && rows[classRowIndex]) {
                        const row = rows[classRowIndex]; row.querySelector('.time-input').value = rowData.time;
                        row.querySelectorAll('.subject-cell').forEach((cell, cellIndex) => {
                            const subjectValue = rowData.subjects[cellIndex]; const select = cell.querySelector('.subject-select');
                            const customInput = cell.querySelector('.custom-subject-input'); let optionExists = Array.from(select.options).some(opt => opt.value === subjectValue);
                            if (optionExists) { select.value = subjectValue; customInput.classList.add('hidden'); } else if (subjectValue) { select.value = '_CUSTOM_'; customInput.classList.remove('hidden'); customInput.value = subjectValue; } else { select.value = ''; customInput.classList.add('hidden'); }
                        }); classRowIndex++;
                    }
                });
            }
            if (settings.scheduleData) {
                applyScheduleData('single', settings.scheduleData.single);
                if (settings['enable-double-week']) { handleDoubleWeekToggle(true); applyScheduleData('double', settings.scheduleData.double); }
            }
            document.getElementById('dutyListConsistent').dispatchEvent(new Event('change'));
        } catch (e) { console.error("Failed to load settings:", e); initDefaults(); }
    }

    function resetSettings() { if (confirm('æ‚¨ç¡®å®šè¦æ¢å¤æ‰€æœ‰é»˜è®¤è®¾ç½®å—ï¼Ÿæ‚¨å½“å‰çš„ç¼–è¾‘å†å²å°†è¢«æ¸…ç©ºã€‚')) { localStorage.removeItem(CONFIG_STORAGE_KEY); location.reload(); } }

    // --- ç•Œé¢ä¸æ ¸å¿ƒé€»è¾‘ ---
    function generateScheduleTables() { const morningPeriods = parseInt(document.getElementById('morning-periods').value) || 0; const afternoonPeriods = parseInt(document.getElementById('afternoon-periods').value) || 0; const singleWrapper = document.getElementById('single-week-table-wrapper'); singleWrapper.innerHTML = createTableHTML(morningPeriods, afternoonPeriods, 'single'); if (document.getElementById('enable-double-week').checked) { handleDoubleWeekToggle(true); } }
    function createSubjectSelect(defaultValue = "") { let html = `<select class="subject-select" onchange="handleSubjectChange(this)">`; let found = false; SUBJECTS.forEach(subject => { const value = typeof subject === 'object' ? subject.value : subject; const text = typeof subject === 'object' ? subject.text : subject; const disabled = typeof subject === 'object' ? subject.disabled : false; const isSelected = (value === defaultValue); if (isSelected) found = true; html += `<option value="${value}" ${isSelected ? 'selected' : ''} ${disabled ? 'disabled' : ''}>${text}</option>`; }); if (!found && defaultValue) { html += `<option value="${defaultValue}" selected>${defaultValue} (è‡ªå®šä¹‰)</option>`; } html += `</select>`; html += `<input type="text" class="custom-subject-input hidden" placeholder="è¯¾ç¨‹å" value="${!found && defaultValue ? defaultValue : ''}">`; return html; }
    function createTableHTML(morning, afternoon, weekType) { const days = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥']; const defaultTimes = ["0740", "0830", "0920", "1020", "1120", "1430", "1540", "1630"]; let table = '<table class="schedule-table">'; table += `<thead><tr><th class="time-header">æ—¶é—´<div class="help-text">æ ¼å¼HHMM</div></th>`; days.forEach(day => table += `<th>æ˜ŸæœŸ${day}</th>`); table += '</tr></thead><tbody>'; let periodIndex = 0; const processRow = () => { let rowHtml = `<tr><td><input type="text" class="time-input" value="${defaultTimes[periodIndex] || ''}"></td>`; days.forEach((day, dayIndex) => { const subject = weekType === 'single' ? (defaultSchedule[`${dayIndex}-${periodIndex}`] || '') : ''; rowHtml += `<td class="subject-cell"><div>${createSubjectSelect(subject)}</div></td>`; }); rowHtml += '</tr>'; periodIndex++; return rowHtml; }; for (let i = 1; i <= morning; i++) table += processRow(); if (morning > 0 && afternoon > 0) table += `<tr class="break-row"><td colspan="${days.length + 1}">åˆä¼‘</td></tr>`; for (let i = 1; i <= afternoon; i++) table += processRow(); table += '</tbody></table>'; return table; }
    function handleSubjectChange(selectElement) { const customInput = selectElement.nextElementSibling; if (selectElement.value === '_CUSTOM_') { customInput.classList.remove('hidden'); customInput.focus(); } else { customInput.classList.add('hidden'); } }
    function handleDoubleWeekToggle(force = false) { const isEnabled = document.getElementById('enable-double-week').checked; const doubleContainer = document.getElementById('double-week-schedule-container'); if (isEnabled || force) { doubleContainer.classList.remove('hidden'); if (document.getElementById('double-week-table-wrapper').innerHTML.trim() === '') { const morning = parseInt(document.getElementById('morning-periods').value) || 0; const afternoon = parseInt(document.getElementById('afternoon-periods').value) || 0; document.getElementById('double-week-table-wrapper').innerHTML = createTableHTML(morning, afternoon, 'double'); } copyScheduleContent('single', 'double'); } else { doubleContainer.classList.add('hidden'); } }
    function copyScheduleContent(sourceWeekType, targetWeekType) { const sourceCells = document.querySelectorAll(`#${sourceWeekType}-week-table-wrapper tbody tr`); const targetCells = document.querySelectorAll(`#${targetWeekType}-week-table-wrapper tbody tr`); if (sourceCells.length !== targetCells.length) return; for (let i = 0; i < sourceCells.length; i++) { const sourceRow = sourceCells[i]; const targetRow = targetCells[i]; const sourceTime = sourceRow.querySelector('.time-input'); const targetTime = targetRow.querySelector('.time-input'); if (sourceTime && targetTime) targetTime.value = sourceTime.value; const sourceSelects = sourceRow.querySelectorAll('.subject-select'); const targetSelects = targetRow.querySelectorAll('.subject-select'); if (sourceSelects.length !== targetSelects.length) continue; for (let j = 0; j < sourceSelects.length; j++) { const sourceSelect = sourceSelects[j]; const targetSelect = targetSelects[j]; const sourceValue = sourceSelect.value === '_CUSTOM_' ? sourceSelect.nextElementSibling.value : sourceSelect.value; let targetHasOption = Array.from(targetSelect.options).some(opt => opt.value === sourceValue); if (targetHasOption) { targetSelect.value = sourceValue; handleSubjectChange(targetSelect); } else { targetSelect.value = '_CUSTOM_'; handleSubjectChange(targetSelect); targetSelect.nextElementSibling.value = sourceValue; } } } }
    function addCountdownItem(name = '', date = '') { const container = document.getElementById('countdown-container'); const item = document.createElement('div'); item.className = 'countdown-item'; item.innerHTML = `<input type="text" class="countdown-name" placeholder="äº‹ä»¶åç§°" value="${name}"><input type="date" class="countdown-date" value="${date}"><button type="button" class="remove-btn" onclick="this.parentElement.remove()">ç§»é™¤</button>`; container.appendChild(item); }
    function parseScheduleTable(weekType) { const wrapper = document.getElementById(`${weekType}-week-table-wrapper`); const rows = wrapper.querySelectorAll('tbody tr'); const dailySchedules = Array.from({ length: 7 }, () => []); rows.forEach(row => { if (row.classList.contains('break-row')) { dailySchedules.forEach(day => day.push('null')); } else { const time = row.querySelector('.time-input').value.trim(); row.querySelectorAll('.subject-cell').forEach((cell, dayIndex) => { const select = cell.querySelector('.subject-select'); let subject = select.value; if (subject === '_CUSTOM_') { subject = cell.querySelector('.custom-subject-input').value.trim(); } if (subject) { dailySchedules[dayIndex].push(`[${time}, "${subject}"]`); } }); } }); const finalOrder = [dailySchedules[6], dailySchedules[0], dailySchedules[1], dailySchedules[2], dailySchedules[3], dailySchedules[4], dailySchedules[5]]; return finalOrder.map(day => { let finalDay = [], inBreak = false; day.forEach(item => { if (item === 'null') { if (!inBreak) finalDay.push(item); inBreak = true; } else { finalDay.push(item); inBreak = false; } }); if (finalDay.every(item => item === 'null' || !item)) return '[]'; return `[${finalDay.join(',\n            ')}]`; }).join(',\n        '); }
    function copyToClipboard() { const output = document.getElementById('output-code'); output.select(); document.execCommand('copy'); alert('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼'); }
    
    // --- ç”Ÿæˆå’Œä¿å­˜ ---
    function generateAndSaveConfig() {
        saveSettings();
        generateConfig();
    }
    
    function generateConfig() {
        const getStr = id => JSON.stringify(document.getElementById(id).value); const getNum = id => document.getElementById(id).value || 0; const getBool = id => document.getElementById(id).checked;
        const announcementList = document.getElementById('announcementList').value.split('\n').filter(line => line.trim()).map(line => JSON.stringify(line.trim())).join(',\n    ');
        const countdownList = Array.from(document.querySelectorAll('.countdown-item')).map(item => { const name = item.querySelector('.countdown-name').value; const date = item.querySelector('.countdown-date').value; return (name && date) ? `["${name}", "${date.replace(/-/g, '/')}"]` : `[]` }).join(',\n    ');
        const dutySingle = `[${getStr('dutySingleSatSun')}, ${getStr('dutySingleMon')}, ${getStr('dutySingleTue')}, ${getStr('dutySingleWed')}, ${getStr('dutySingleThu')}, ${getStr('dutySingleFri')}, ${getStr('dutySingleSatSun')}]`;
        const dutyDouble = `[${getStr('dutyDoubleSatSun')}, ${getStr('dutyDoubleMon')}, ${getStr('dutyDoubleTue')}, ${getStr('dutyDoubleWed')}, ${getStr('dutyDoubleThu')}, ${getStr('dutyDoubleFri')}, ${getStr('dutyDoubleSatSun')}]`;
        const subjectListConsistent = !getBool('enable-double-week'); const singleWeekData = parseScheduleTable('single'); const doubleWeekData = subjectListConsistent ? singleWeekData : parseScheduleTable('double');
        const template = `// ... (æ­¤å¤„ä¸ºç”Ÿæˆconfig.jså†…å®¹çš„æ¨¡æ¿å­—ç¬¦ä¸²ï¼Œä¸ä¸Šä¸€ç‰ˆç›¸åŒï¼Œä¸ºç®€æ´çœç•¥) ...`;
        document.getElementById('output-code').value = `// Generated on ${new Date().toLocaleString()}\nvar revWeek = ${getBool('revWeek')};\nvar temporaryDayOfWeek = ${document.getElementById('temporaryDayOfWeek').value};\nvar announcementList = [${announcementList}];\nvar announcementRandomOrder = ${getBool('announcementRandomOrder')};\nvar countdownList = [${countdownList}];\nvar countdownShowPastDate = ${getBool('countdownShowPastDate')};\nvar countdownAnimation = ${getBool('countdownAnimation')};\nvar dutyListConsistent = ${getBool('dutyListConsistent')};\nvar dutyList = [${dutySingle}, ${dutyDouble}];\nvar emojiEnabled = ${getBool('emojiEnabled')};\nvar emojiFilename = [];\nvar subjectListConsistent = ${subjectListConsistent};\nvar subjectList = [[${singleWeekData}],[${doubleWeekData}]];\nvar defaultClassDuration = 40;\nvar promptAfterSchool = "è¯·ä»Šæ—¥å€¼æ—¥ç”Ÿåšå¥½å€¼æ—¥å·¥ä½œ";\nvar promptEmptySchedule = "ä»Šæ—¥æ— è¯¾";\nvar showTimeSeconds = ${getBool('showTimeSeconds')};\nvar updateInterval = 500;\nvar promptUpdateDelay = 2;`;
        document.getElementById('output-container').classList.remove('hidden'); window.scrollTo(0, document.body.scrollHeight); alert('é…ç½®å·²ç”Ÿæˆï¼');
    }

    // --- é¡µé¢åŠ è½½ ---
    function initDefaults() {
        console.log('Initializing with default values.');
        generateScheduleTables();
        addCountdownItem('é«˜è€ƒ', '2026-06-07');
        addCountdownItem('æƒ ä¸€è°ƒ', '2025-07-03');
        document.getElementById('duty-double-week-panel').style.display = 'none';
        // è®¾ç½®é»˜è®¤å€¼
        document.getElementById('revWeek').checked = true;
        document.getElementById('announcementRandomOrder').checked = true;
        document.getElementById('dutyListConsistent').checked = true;
        document.getElementById('showTimeSeconds').checked = true;
        document.getElementById('emojiEnabled').checked = true;
    }

    window.onload = loadSettings;
</script>
</body>
</html>